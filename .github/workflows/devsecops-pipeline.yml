name: DevSecOps Pipeline
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
env:
  DOCKER_IMAGE_NAME: vuln-bank
  DOCKER_TAG: ${{ github.sha }}

jobs:
  secret-scanning:
    name: Secret Scanning
    runs-on: ubuntu-latest
    outputs:
      secrets-found: ${{ steps.gitleaks.outputs.secrets-found }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Run GitLeaks
        id: gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true
      
      - name: Check GitLeaks Results
        run: |
          if [ "${{ steps.gitleaks.outcome }}" == "failure" ]; then
            echo "secrets-found=true" >> $GITHUB_OUTPUT
            echo "ðŸš¨ Secrets detected by GitLeaks!"
            exit 1
          else
            echo "secrets-found=false" >> $GITHUB_OUTPUT
            echo "âœ… No secrets detected"
          fi
      
      - name: Upload GitLeaks Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: gitleaks-report
          path: results.sarif
          retention-days: 1

  snyk-sca:
    name: SCA - Snyk Analysis
    runs-on: ubuntu-latest
    needs: secret-scanning
    if: needs.secret-scanning.outputs.secrets-found == 'false'
    outputs:
      vulnerabilities-found: ${{ steps.snyk-scan.outputs.vulnerabilities-found }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run Snyk to check for vulnerabilities
        id: snyk-scan
        uses: snyk/actions/python@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --json-file-output=snyk-report.json
        continue-on-error: true
      
      - name: Process Snyk Results
        run: |
          if [ "${{ steps.snyk-scan.outcome }}" == "failure" ]; then
            echo "vulnerabilities-found=true" >> $GITHUB_OUTPUT
            echo "ðŸš¨ High/Critical vulnerabilities found!"
            
            # Show vulnerability summary if report exists
            if [ -f snyk-report.json ]; then
              echo "ðŸ“‹ Vulnerability Summary:"
              jq -r '.vulnerabilities[]? | select(.severity == "high" or .severity == "critical") | "- \(.title) (\(.severity)): \(.packageName)@\(.version)"' snyk-report.json | head -5
            fi
            
            # Continue deployment but with warning
            echo "âš ï¸ Continuing deployment with vulnerabilities (review recommended)"
          else
            echo "vulnerabilities-found=false" >> $GITHUB_OUTPUT
            echo "âœ… No high/critical vulnerabilities found"
          fi
      
      - name: Upload Snyk Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: snyk-report
          path: snyk-report.json
          retention-days: 1
