name: DevSecOps Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  DOCKER_IMAGE_NAME: vuln-bank
  DOCKER_TAG: ${{ github.sha }}

jobs:
  secret-scanning:
    name: 🔍 Secret Scanning
    runs-on: ubuntu-latest
    outputs:
      secrets-found: ${{ steps.gitleaks.outputs.secrets-found }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run GitLeaks
        id: gitleaks
        run: |
          wget -q https://github.com/gitleaks/gitleaks/releases/latest/download/gitleaks_linux_x64.tar.gz
          tar -xzf gitleaks_linux_x64.tar.gz
          chmod +x gitleaks
          

          echo "🔍 Scanning for secrets..."
          ./gitleaks detect --config .gitleaks.toml --report-format json --report-path gitleaks-report.json --no-git --verbose || GITLEAKS_EXIT_CODE=$?
          
          if [ -f gitleaks-report.json ] && [ -s gitleaks-report.json ]; then
            echo "secrets-found=true" >> $GITHUB_OUTPUT
            echo "🚨 Secrets found in code!"
            cat gitleaks-report.json
            exit 1
          else
            echo "secrets-found=false" >> $GITHUB_OUTPUT
            echo "✅ No secrets detected"
          fi

      - name: Upload GitLeaks Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: gitleaks-report
          path: gitleaks-report.json
          retention-days: 1
